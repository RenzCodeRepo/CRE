@model CRE.ViewModels.UploadFormsViewModel
@{
    ViewBag.Title = "Upload Requirements";
}

<h2>Application Requirements</h2>

<div class="card border-light mb-3" style="width:contain">
    <div class="card-header">
        <div class="row">
            <div class="col text-start">
                <p id="urecNoText">
                    <strong>UREC No.: </strong> @Model.EthicsApplication.urecNo
                </p>
                <button type="button" class="btn btn-primary ms-2" onclick="copyUrecNo()">
                    Copy UREC No.
                </button>

                <h4><strong>Research Title:</strong>@Model.NonFundedResearchInfo.title</h4>
                <p>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Proponent/s:</strong><br />
                            @($"{Model.User.fName} {Model.User.mName} {Model.User.lName}")
                            <br />
                            @if (Model.CoProponent != null && Model.CoProponent.Any())
                            {
                                foreach (var proponent in Model.CoProponent)
                                {
                                    @proponent.coProponentName <br />
                                }
                            }
                        </div>
                    </div>
                </p>
                <p><strong>Field of Study:</strong> @Model.EthicsApplication.fieldOfStudy</p>
                <p><strong>Collge: </strong> @Model.NonFundedResearchInfo.college</p>
                <p><strong>Branch/Campuses: </strong> @Model.NonFundedResearchInfo.campus</p>
            </div>

            <!-- Display DTS No. or Edit Button -->
            <div class="col text-end">
                <p id="dtsNoText">
                    <strong>DTS No.:</strong>
                    @if (string.IsNullOrEmpty(Model.EthicsApplication.dtsNo))
                    {
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editDtsModal">Add DTS No.</button>
                    }
                    else
                    {
                        @Model.EthicsApplication.dtsNo
                    }
                </p>
                <!-- Button to Copy DTS No. if it exists -->
                @if (!string.IsNullOrEmpty(Model.EthicsApplication.dtsNo)) // Ensure the button only shows if DTS No. exists
                {
                    <button type="button" class="btn btn-primary ms-2" onclick="copyDtsNo()">
                        Copy DTS No.
                    </button>
                }
            </div>

            <!-- Modal for Adding/Editing DTS No. -->
            <div class="modal fade" id="editDtsModal" tabindex="-1" aria-labelledby="editDtsLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editDtsLabel">Edit DTS No.</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editDtsForm" method="post" asp-action="UpdateDtsNo" asp-controller="EthicsApplication">
                                <div class="mb-3">
                                    <label for="dtsNoInput" class="form-label">DTS No.</label>
                                    <input type="text" class="form-control" id="dtsNoInput" name="dtsNo" required />
                                </div>
                                <input type="hidden" name="urecNo" value="@Model.EthicsApplication.urecNo" />
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" form="editDtsForm" class="btn btn-primary">Save DTS No.</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-light mb-3" style="width">
    <div class="card-header"><h2>Your Attachments</h2></div>
    <div class="card-body">
        <form id="myForm" asp-action="ApplicationRequirements" enctype="multipart/form-data" method="post">
            <input type="hidden" name="EthicsApplication.urecNo" value="@Model.EthicsApplication.urecNo" />

            <div>
                <label asp-for="Form9">Upload Ethics Form 9 Application for Ethics Review of New Protocol:</label>
                <input asp-for="Form9" class="form-control form-control-sm" type="file" accept=".pdf" />
                <span asp-validation-for="Form9" class="text-danger"></span>
            </div>

            <div>
                <label asp-for="Form10">Upload Ethics Form 10 Research Study Protocol:</label>
                <input asp-for="Form10" class="form-control form-control-sm" type="file" accept=".pdf" />
                <span asp-validation-for="Form10" class="text-danger"></span>
            </div>

            <div>
                <label asp-for="RCV">Upload Researcher Curriculum Vitae:</label>
                <input asp-for="RCV" class="form-control form-control-sm" type="file" accept=".pdf" />
                <span asp-validation-for="RCV" class="text-danger"></span>
            </div>

            <div>
                <label asp-for="CV">Upload Certificate of Validity:</label>
                <input asp-for="CV" class="form-control form-control-sm" type="file" accept=".pdf" />
                <span asp-validation-for="CV" class="text-danger"></span>
            </div>

            <div>
                <label asp-for="CAA">Upload Co-Authorship Agreement:</label>
                <input asp-for="CAA" class="form-control form-control-sm" type="file" accept=".pdf" />
                <span asp-validation-for="CAA" class="text-danger"></span>
            </div>

            <div>
                <label asp-for="LI">Upload Letter of Intent:</label>
                <input asp-for="LI" class="form-control form-control-sm" type="file" accept=".pdf" />
                <span asp-validation-for="LI" class="text-danger"></span>
            </div>

            <hr />
            <!-- Condition Section -->
            <div>
                <p>
                    <strong>Does the research involve human subjects?</strong>
                    <label for="human-subjects-yes">
                        <input type="radio" id="human-subjects-yes" name="humanSubjects" value="yes" onclick="updateFormState(true)" /> Yes
                    </label>
                    <label for="human-subjects-no">
                        <input type="radio" id="human-subjects-no" name="humanSubjects" value="no" onclick="updateFormState(false)" checked /> No
                    </label>
                </p>
            </div>

            <!-- Minors Question Section -->
            <div id="minors-question" style="display:none;">
                <p>
                    <strong>Will the research involve minors?</strong>
                    <label for="minors-yes">
                        <input type="radio" id="minors-yes" name="involvesMinors" value="yes" onclick="updateFormStateWithMinors(true)" /> Yes
                    </label>
                    <label for="minors-no">
                        <input type="radio" id="minors-no" name="involvesMinors" value="no" onclick="updateFormStateWithMinors(false)" checked /> No
                    </label>
                </p>
            </div>

            <!-- Upload Sections -->
            <div>
                <div>
                    <label asp-for="Form11">Upload Ethics Form 11 Informed Consent:</label>
                    <input asp-for="Form11" id="form11-file" class="form-control form-control-sm" type="file" accept=".pdf" disabled />
                    <span asp-validation-for="Form11" class="text-danger"></span>
                </div>

                <div>
                    <label asp-for="Form12">Upload Ethics Form 12 Assent Form:</label>
                    <input asp-for="Form12" id="form12-file" class="form-control form-control-sm" type="file" accept=".pdf" disabled />
                    <span asp-validation-for="Form12" class="text-danger"></span>
                </div>

                <div>
                    <label asp-for="Form10_1">Upload Ethics Form 10.1 Non-Human Determination Form:</label>
                    <input asp-for="Form10_1" id="form10-1-file" class="form-control form-control-sm" type="file" accept=".pdf" disabled />
                    <span asp-validation-for="Form10_1" class="text-danger"></span>
                </div>
            </div>

            <button type="submit" id="submitButton" class="btn btn-success mt-2">Submit</button>
        </form>
    </div>
</div>
@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize form states based on default selections
            const humanSubjectsSelected = $('input[name="humanSubjects"]:checked').val();
            updateFormState(humanSubjectsSelected === "yes");

            $('#myForm').on('submit', function () {
                // Clear validation messages for disabled inputs
                $('#form11-file, #form12-file, #form10-1-file').siblings('.text-danger').text('');
            });
        });

        function updateFormState(hasHumanSubjects) {
            $('#minors-question').toggle(hasHumanSubjects);
            if (!hasHumanSubjects) {
                // No human subjects involved
                $('#form10-1-file').prop('disabled', false); // Enable Form 10.1
                $('#form11-file, #form12-file').prop('disabled', true).val('').siblings('.text-danger').text(''); // Disable Forms 11 and 12
            } else {
                // Human subjects involved
                $('#form10-1-file').prop('disabled', true).val('').siblings('.text-danger').text(''); // Disable Form 10.1
                $('#form11-file').prop('disabled', false); // Enable Form 11
                $('#form12-file').prop('disabled', true).val('').siblings('.text-danger').text(''); // Disable Form 12 initially

                // Check if minors are involved
                const minorsSelected = $('input[name="involvesMinors"]:checked').val();
                if (minorsSelected === "yes") {
                    $('#form12-file').prop('disabled', false); // Enable Form 12 if minors are involved
                }
            }
        }

        function updateFormStateWithMinors(involvesMinors) {
            if (involvesMinors) {
                // If it involves minors, enable Form 12
                $('#form12-file').prop('disabled', false);
            } else {
                // If it does not involve minors, keep Form 12 disabled
                $('#form12-file').prop('disabled', true).val('').siblings('.text-danger').text('');
            }
        }

        function copyUrecNo() {
            const urecNo = document.getElementById("urecNoText").innerText.split(': ')[1];
            navigator.clipboard.writeText(urecNo).then(() => {
                alert("UREC No. copied to clipboard!");
            });
        }

        function copyDtsNo() {
            const dtsNo = document.getElementById("dtsNoText").innerText.split(': ')[1];
            navigator.clipboard.writeText(dtsNo).then(() => {
                alert("DTS No. copied to clipboard!");
            });
        }
    </script>
}