@model CRE.ViewModels.UploadFormsViewModel
@{
    ViewBag.Title = "Upload Requirements";
    var anyFormsUploaded = Model?.EthicsApplicationForms?.Any(f =>
                (f.ethicsFormId == "FORM11" || f.ethicsFormId == "FORM12" || f.ethicsFormId == "FORM10_1") && f.file != null
                ) == true;

    // Check if the required forms from Form 9 to Letter of Intent are uploaded
    var allMainFormsUploaded = Model?.EthicsApplicationForms?.All(f =>
        f.file != null &&
        (f.ethicsFormId == "FORM9" ||
         f.ethicsFormId == "FORM10" ||
         f.ethicsFormId == "FORM11" ||
         f.ethicsFormId == "FORM12" ||
         f.ethicsFormId == "CAA" ||
         f.ethicsFormId == "RCV" ||
         f.ethicsFormId == "CV" ||
         f.ethicsFormId == "LI")
    ) == true;

    // Check if at least one of Form 11, 12, or 10.1 is uploaded
    var anyConditionalFormsUploaded = Model?.EthicsApplicationForms?.Any(f =>
        (f.ethicsFormId == "FORM11" ||
         f.ethicsFormId == "FORM12" ||
         f.ethicsFormId == "FORM10_1") &&
         f.file != null
    ) == true;

    // All conditions for the submit and track buttons
    var allFormsUploaded = allMainFormsUploaded && anyConditionalFormsUploaded;
}

<h2>Application Requirements</h2>

<div class="card border-light mb-3" style="width:contain">
    <div class="card-header">
        <div class="row">
            <div class="col text-start">
                <p id="urecNoText">
                    <strong>UREC No.: </strong> @Model.EthicsApplication.urecNo
                </p>
                <button type="button" class="btn btn-primary ms-2" onclick="copyUrecNo()">
                    Copy UREC No.
                </button>

                <h4><strong>Research Title:</strong>@Model.NonFundedResearchInfo.title</h4>
                <p>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Proponent/s:</strong><br />
                            @($"{Model.User.fName} {Model.User.mName} {Model.User.lName}")
                            <br />
                            @if (Model.CoProponent != null && Model.CoProponent.Any())
                            {
                                foreach (var proponent in Model.CoProponent)
                                {
                                    @proponent.coProponentName <br />
                                }
                            }
                        </div>
                    </div>
                </p>
                <p><strong>Field of Study:</strong> @Model.EthicsApplication.fieldOfStudy</p>
                <p><strong>Collge: </strong> @Model.NonFundedResearchInfo.college</p>
                <p><strong>Branch/Campuses: </strong> @Model.NonFundedResearchInfo.campus</p>
            </div>
            <!-- Display DTS No. or Edit Button -->
            <div class="col text-end">
                <p id="dtsNoText">
                    <strong>DTS No.:</strong>
                    @if (string.IsNullOrEmpty(Model.EthicsApplication.dtsNo))
                    {
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editDtsModal">Add DTS No.</button>
                    }
                    else
                    {
                        @Model.EthicsApplication.dtsNo
                    }
                </p>

                <!-- Button to Copy DTS No. if it exists -->
                @if (!string.IsNullOrEmpty(Model.EthicsApplication.dtsNo))
                {
                    <button type="button" class="btn btn-primary ms-2" onclick="copyDtsNo()">
                        Copy DTS No.
                    </button>
                }
            </div>

            <!-- Modal for Adding/Editing DTS No. -->
            <div class="modal fade" id="editDtsModal" tabindex="-1" aria-labelledby="editDtsLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editDtsLabel">Edit DTS No.</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="errorMessages" class="text-danger mb-2"></div> <!-- Error message display -->
                            <form id="editDtsForm" method="post" asp-action="UpdateDtsNo" asp-controller="EthicsApplicationForms">
                                <div class="mb-3">
                                    <label for="dtsNoInput" class="form-label">DTS No.</label>
                                    <input type="text" class="form-control" id="dtsNoInput" name="dtsNo"
                                           value="@Model.EthicsApplication.dtsNo"
                                           required
                                           pattern="\d{4}-\d{4}-\d{2}"
                                           title="DTS No. must be in the format xxxx-xxxx-xx" />
                                    <span id="dtsNoError" class="text-danger"></span> <!-- Dynamic JS error -->
                                    @Html.ValidationMessage("dtsNo", "", new { @class = "text-danger" }) <!-- Server-side error -->
                                </div>
                                <input type="hidden" name="urecNo" value="@Model.EthicsApplication.urecNo" />
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="submitDtsForm">Save DTS No.</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-light mb-3" style="width">
    <div class="card-header"><h2>Your Attachments</h2></div>
    <div class="card-body">
        @* Display receipt PDF link if it exists in the database *@
        @if (Model.ReceiptInfo != null && Model.ReceiptInfo.scanReceipt != null)
        {
            <div class="mb-3">
                <label><strong>Receipt:</strong></label>
                <a href="@Url.Action("ViewReceipt", "ReceiptInfo", new { urecNo = Model.EthicsApplication?.urecNo })" target="_blank" class="btn btn-primary btn-sm">
                    View Receipt (PDF)
                </a>
            </div>
        }

        <form id="myForm" asp-action="UploadForms" enctype="multipart/form-data" method="post">
            <input type="hidden" name="EthicsApplication.urecNo" value="@Model.EthicsApplication.urecNo" />

            <div>
                <label asp-for="FORM9">Upload Ethics Form 9 Application for Ethics Review of New Protocol:</label>
                @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "FORM9") == true)
                {
                    <p>
                        <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "FORM9", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                            View Uploaded Form 9
                        </a>
                        <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "FORM9", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                            Download Form 9
                        </a>
                    </p>
                }
                else
                {
                    <input asp-for="FORM9" class="form-control form-control-sm" type="file" accept=".pdf" />
                    <span asp-validation-for="FORM9" class="text-danger"></span>
                }
            </div>

            <div>
                <label asp-for="FORM10">Upload Ethics Form 10 Research Study Protocol:</label>
                @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "FORM10") == true)
                {
                    <p>
                        <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "FORM10", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                            View Uploaded Form 10
                        </a>
                        <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "FORM10", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                            Download Form 10
                        </a>
                    </p>
                }
                else
                {
                    <input asp-for="FORM10" class="form-control form-control-sm" type="file" accept=".pdf" />
                    <span asp-validation-for="FORM10" class="text-danger"></span>
                }
            </div>

            <div>
                <label asp-for="RCV">Upload Researcher Curriculum Vitae:</label>
                @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "RCV") == true)
                {
                    <p>
                        <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "RCV", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                            View Uploaded RCV
                        </a>
                        <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "RCV", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                            Download RCV
                        </a>
                    </p>
                }
                else
                {
                    <input asp-for="RCV" class="form-control form-control-sm" type="file" accept=".pdf" />
                    <span asp-validation-for="RCV" class="text-danger"></span>
                }
            </div>

            <div>
                <label asp-for="CV">Upload Certificate of Validity:</label>
                @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "CV") == true)
                {
                    <p>
                        <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "CV", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                            View Uploaded CV
                        </a>
                        <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "CV", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                            Download CV
                        </a>
                    </p>
                }
                else
                {
                    <input asp-for="CV" class="form-control form-control-sm" type="file" accept=".pdf" />
                    <span asp-validation-for="CV" class="text-danger"></span>
                }
            </div>

            <div>
                <label asp-for="CAA">Upload Co-Authorship Agreement:</label>
                @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "CAA") == true)
                {
                    <p>
                        <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "CAA", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                            View Uploaded CAA
                        </a>
                        <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "CAA", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                            Download CAA
                        </a>
                    </p>
                }
                else
                {
                    <input asp-for="CAA" class="form-control form-control-sm" type="file" accept=".pdf" />
                    <span asp-validation-for="CAA" class="text-danger"></span>
                }
            </div>

            <div>
                <label asp-for="LI">Upload Letter of Intent:</label>
                @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "LI") == true)
                {
                    <p>
                        <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "LI", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                            View Uploaded LI
                        </a>
                        <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "LI", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                            Download LI
                        </a>
                    </p>
                }
                else
                {
                    <input asp-for="LI" class="form-control form-control-sm" type="file" accept=".pdf" />
                    <span asp-validation-for="LI" class="text-danger"></span>
                }
            </div>


            <hr />
            <!-- Condition Section -->
            <div>
                @* Check if any of the specified forms have been uploaded *@
                @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "FORM11" || f.ethicsFormId == "FORM12" || f.ethicsFormId == "FORM10_1") == true)
                {
                // If any of the forms are uploaded, remove condition questions
                    <p>Condition questions have been removed because one or more forms have been uploaded.</p>
                }
                else
                {
                    <p>
                        <strong>Does the research involve human subjects?</strong>
                        <label for="human-subjects-yes">
                            <input type="radio" id="human-subjects-yes" name="InvolvesHumanSubjects" value="true" onclick="updateFormState(true)" /> Yes
                        </label>
                        <label for="human-subjects-no">
                            <input type="radio" id="human-subjects-no" name="InvolvesHumanSubjects" value="false" onclick="updateFormState(false)" checked /> No
                        </label>
                    </p>

                    <!-- Minors Question Section -->
                    <div id="minors-question" style="display:none;">
                        <p>
                            <strong>Will the research involve minors?</strong>
                            <label for="minors-yes">
                                <input type="radio" id="minors-yes" name="InvolvesMinors" value="true" onclick="updateFormStateWithMinors(true)" /> Yes
                            </label>
                            <label for="minors-no">
                                <input type="radio" id="minors-no" name="InvolvesMinors" value="false" onclick="updateFormStateWithMinors(false)" checked /> No
                            </label>
                        </p>
                    </div>
                }
            </div>

            <!-- Upload Sections -->
            <div>
                @if (!anyFormsUploaded) // If none of the forms are uploaded, display upload inputs
                {
                    <div>
                        <label asp-for="FORM11">Upload Ethics Form 11 Informed Consent:</label>
                        <input asp-for="FORM11" id="form11-file" class="form-control form-control-sm" type="file" accept=".pdf" />
                        <span asp-validation-for="FORM11" class="text-danger"></span>
                    </div>

                    <div>
                        <label asp-for="FORM12">Upload Ethics Form 12 Assent Form:</label>
                        <input asp-for="FORM12" id="form12-file" class="form-control form-control-sm" type="file" accept=".pdf" />
                        <span asp-validation-for="FORM12" class="text-danger"></span>
                    </div>

                    <div>
                        <label asp-for="FORM10_1">Upload Ethics Form 10.1 Non-Human Determination Form:</label>
                        <input asp-for="FORM10_1" id="form10-1-file" class="form-control form-control-sm" type="file" accept=".pdf" />
                        <span asp-validation-for="FORM10_1" class="text-danger"></span>
                    </div>
                }
                else // If any of the forms have been uploaded, show buttons to view/download
                {
                    @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "FORM11") == true)
                    {
                        <p>
                            <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "FORM11", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                                View Uploaded Form 11
                            </a>
                            <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "FORM11", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                                Download Form 11
                            </a>
                        </p>
                    }

                    @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "FORM12") == true)
                    {
                        <p>
                            <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "FORM12", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                                View Uploaded Form 12
                            </a>
                            <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "FORM12", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                                Download Form 12
                            </a>
                        </p>
                    }

                    @if (Model?.EthicsApplicationForms?.Any(f => f.ethicsFormId == "FORM10_1") == true)
                    {
                        <p>
                            <a href="@Url.Action("ViewFile", "EthicsApplicationForms", new { formId = "FORM10_1", urecNo = Model.EthicsApplication.urecNo })" target="_blank" class="btn btn-primary">
                                View Uploaded Form 10.1
                            </a>
                            <a href="@Url.Action("DownloadFile", "EthicsApplicationForms", new { formId = "FORM10_1", urecNo = Model.EthicsApplication.urecNo })" class="btn btn-secondary">
                                Download Form 10.1
                            </a>
                        </p>
                    }
                }
            </div>

            <!-- Track Application / Submit Button -->
            @if (allFormsUploaded)
            {
                <a href="@Url.Action("TrackApplication", "EthicsApplicationlog", new { urecNo = Model.EthicsApplication.urecNo })" class="btn btn-success mt-2">
                    Track Application
                </a>
            }
            else
            {
                <button type="submit" id="submitButton" class="btn btn-success mt-2">Submit</button>
            }
        </form>
    </div>
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
</div>
@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script type="text/javascript">
        // Add confirmation before submitting the form
        document.getElementById('myForm').addEventListener('submit', function (event) {
            // Show confirmation dialog
            var confirmSubmit = confirm('Are you sure you want to submit the form with the current files?');

            // If the user cancels, prevent form submission
            if (!confirmSubmit) {
                event.preventDefault();
            }
        });
    </script>
    <script>
        $(document).ready(function () {
            $('#submitDtsForm').click(function (e) {
                e.preventDefault();
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("UpdateDtsNo", "EthicsApplicationForms")',
                    data: $('#editDtsForm').serialize(),
                    success: function (response) {
                        if (response.success) {
                            $('#editDtsModal').modal('hide');
                            $('#dtsNoText').html('<strong>DTS No.:</strong> ' + response.dtsNo);
                        } else {
                            // Check if errors are defined and display them
                            if (response.errors && response.errors.length > 0) {
                                $('#errorMessages').html(response.errors.join('<br />'));
                            } else {
                                $('#errorMessages').html("An unexpected error occurred.");
                            }
                        }
                    },
                    error: function () {
                        $('#errorMessages').html("An error occurred. Please try again.");
                    }
                });
            });
        });
    </script>
    <script>
        document.getElementById('submitDtsForm').addEventListener('click', function () {
            var dtsNoInput = document.getElementById('dtsNoInput');
            var errorMessage = document.getElementById('dtsNoError');
            var dtsPattern = /^\d{4}-\d{4}-\d{2}$/;  // Regular expression for xxxx-xxxx-xx

            if (!dtsPattern.test(dtsNoInput.value)) {
                errorMessage.textContent = "DTS No. must be in the format xxxx-xxxx-xx.";
            } else {
                errorMessage.textContent = "";  // Clear error if valid
                document.getElementById('editDtsForm').submit(); // Submit the form if valid
            }
        });
    </script>
    <script>
        $(document).ready(function () {
            // Initialize form states based on default selections
            const humanSubjectsSelected = $('input[name="humanSubjects"]:checked').val();
            updateFormState(humanSubjectsSelected === "yes");

            $('#myForm').on('submit', function () {
                // Clear validation messages for disabled inputs
                $('#form11-file, #form12-file, #form10-1-file').siblings('.text-danger').text('');
            });
        });

        function updateFormState(hasHumanSubjects) {
            $('#minors-question').toggle(hasHumanSubjects);
            if (!hasHumanSubjects) {
                $('#form10-1-file').prop('disabled', false);
                $('#form11-file, #form12-file').prop('disabled', true).val('').siblings('.text-danger').text('');
            } else {
                $('#form10-1-file').prop('disabled', true).val('').siblings('.text-danger').text('');
                $('#form11-file').prop('disabled', false);
                $('#form12-file').prop('disabled', true).val('').siblings('.text-danger').text('');

                const minorsSelected = $('input[name="InvolvesMinors"]:checked').val();
                if (minorsSelected === "true") {
                    $('#form12-file').prop('disabled', false);
                }
            }
        }

        function updateFormStateWithMinors(involvesMinors) {
            if (involvesMinors) {
                // If it involves minors, enable Form 12
                $('#form12-file').prop('disabled', false);
            } else {
                // If it does not involve minors, keep Form 12 disabled
                $('#form12-file').prop('disabled', true).val('').siblings('.text-danger').text('');
            }
        }

        function copyUrecNo() {
            const urecNo = document.getElementById("urecNoText").innerText.split(': ')[1];
            navigator.clipboard.writeText(urecNo).then(() => {
                alert("UREC No. copied to clipboard!");
            });
        }

        function copyDtsNo() {
            const dtsNo = document.getElementById("dtsNoText").innerText.split(': ')[1];
            navigator.clipboard.writeText(dtsNo).then(() => {
                alert("DTS No. copied to clipboard!");
            });
        }
    </script>
}